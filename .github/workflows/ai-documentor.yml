name: Run AI Documentor

on:
  push:
    branches:
      - develop
  pull_request:
    branches:
      - develop

env:
  AGENT_IMAGE: registry.gitlab.com/paul_lepine_solutions/ai-documentor/agent-test:latest
  DOCKER_DRIVER: overlay2
  REPO_PATH: /home/agent/repo

jobs:
  documentation:
    name: Run AI Documentor
    runs-on: ubuntu-latest

    services:
      docker:
        image: docker:dind
        options: --privileged
        ports:
          - 2375:2375
        env:
          DOCKER_TLS_CERTDIR: ""

    env:
      MODEL_API_KEY: ${{ secrets.MODEL_API_KEY }}
      SSH_PRIVATE_KEY: ${{ secrets.SSH_PRIVATE_KEY }}
      DOCKER_USER: ${{ secrets.DOCKER_USER }}
      DOCKER_PASSWORD: ${{ secrets.DOCKER_PASSWORD }}
      REPO_USER_NAME: ${{ secrets.REPO_USER_NAME }}
      REPO_USER_EMAIL: ${{ secrets.REPO_USER_EMAIL }}

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Docker CLI
        run: |
          sudo apt-get update
          sudo apt-get install -y docker-ce-cli

      - name: Log in to Docker registry
        run: echo "${DOCKER_PASSWORD}" | docker login -u "${DOCKER_USER}" --password-stdin registry.gitlab.com

      - name: Prepare SSH key
        run: |
          mkdir -p ~/.ssh
          echo "${SSH_PRIVATE_KEY}" > ~/.ssh/id_ed25519
          chmod 700 ~/.ssh
          chmod 600 ~/.ssh/id_ed25519
          ssh-keyscan github.com >> ~/.ssh/known_hosts

      - name: Determine Agent UID and GID
        id: agent_ids
        run: |
          echo "uid=$(docker run --rm --entrypoint='' $AGENT_IMAGE id -u agent)" >> $GITHUB_OUTPUT
          echo "gid=$(docker run --rm --entrypoint='' $AGENT_IMAGE id -g agent)" >> $GITHUB_OUTPUT

      - name: Adjust permissions
        run: |
          sudo chown -R ${{ steps.agent_ids.outputs.uid }}:${{ steps.agent_ids.outputs.gid }} ~/.ssh

      - name: Run AI Documentor
        run: |
          mkdir -p ${REPO_PATH}
          docker run --rm \
            -v "$(pwd):${REPO_PATH}" \
            -v "$HOME/.ssh:/home/agent/.ssh" \
            -e MODEL_API_KEY="${MODEL_API_KEY}" \
            -e REPO_USER_NAME="${REPO_USER_NAME}" \
            -e REPO_USER_EMAIL="${REPO_USER_EMAIL}" \
            -e GIT_SSH_COMMAND="ssh -i /home/agent/.ssh/id_ed25519 -o StrictHostKeyChecking=no" \
            ${AGENT_IMAGE} \
            full --commit-sha ${{ github.sha }} --branch ${{ github.ref_name }}
