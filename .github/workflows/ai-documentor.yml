name: Run AI Documentor
on:
  push:
    branches:
      - develop
  pull_request:
    branches:
      - develop
env:
  AGENT_IMAGE: registry.gitlab.com/paul_lepine_solutions/ai-documentor/agent-test-v4:latest
  DOCKER_DRIVER: overlay2
  REPO_PATH: /home/agent/repo
jobs:
  documentation:
    name: Run AI Documentor
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
      
      - name: Log in to Docker registry
        run: echo "${{ secrets.DOCKER_PASSWORD }}" | docker login -u "${{ secrets.DOCKER_USER }}" --password-stdin registry.gitlab.com
      
      - name: Prepare SSH key
        run: |
          mkdir -p ~/.ssh
          echo "${{ secrets.SSH_PRIVATE_KEY }}" > ~/.ssh/id_ed25519
          chmod 700 ~/.ssh
          chmod 600 ~/.ssh/id_ed25519
          ssh-keyscan github.com >> ~/.ssh/known_hosts
      
      - name: Determine Agent UID and GID
        id: agent_ids
        run: |
          echo "uid=$(docker run --rm --entrypoint='' ${{ env.AGENT_IMAGE }} id -u agent)" >> $GITHUB_OUTPUT
          echo "gid=$(docker run --rm --entrypoint='' ${{ env.AGENT_IMAGE }} id -g agent)" >> $GITHUB_OUTPUT
      
      - name: Adjust permissions
        run: |
          sudo chown -R ${{ steps.agent_ids.outputs.uid }}:${{ steps.agent_ids.outputs.gid }} ~/.ssh
      
      - name: Run AI Documentor
        run: |
          docker run --rm \
            -v "${{ github.workspace }}:${{ env.REPO_PATH }}" \
            -v "${HOME}/.ssh:/home/agent/.ssh:ro" \
            -e MODEL_API_KEY="${{ secrets.MODEL_API_KEY }}" \
            -e REPO_USER_NAME="${{ github.actor }}" \
            -e REPO_USER_EMAIL="${{ github.actor }}@users.noreply.github.com" \
            -e GIT_REMOTE_URL="git@github.com:${{ github.repository }}.git" \
            ${{ env.AGENT_IMAGE }} \
            full --commit-sha "${{ github.sha }}" --branch "${{ github.ref_name }}"